# **Explore with me**

<!-- TOC -->
* [**Explore with me**](#explore-with-me)
  * [Description](#description)
  * [Main functions](#main-functions)
  * [Application architecture](#application-architecture)
  * [Schema of database](#schema-of-database)
  * [Applied technologies](#applied-technologies)
  * [How to Start a Program](#how-to-start-a-program)
    * [Docker](#docker)
    * [Kubernetes](#kubernetes)
    * [Helm chart](#helm-chart)
  * [Description of feature](#description-of-feature)
<!-- TOC -->

## Description
Свободное время — ценный ресурс. Ежедневно мы планируем, как его потратить — куда и с кем сходить. Сложнее всего в таком планировании поиск информации и переговоры. 
Необходимо учесть много деталей: какие намечаются мероприятия, свободны ли в этот момент друзья, как всех пригласить и где собраться.
Созданное приложение — это афиша. В этой афише можно предложить какое-либо событие от выставки до похода в кино и собрать компанию для участия в нём.

[back to table of content](#explore-with-me)

## Main functions
В приложении реализовано два сервиса:
- основной сервис будет содержать всё необходимое для работы продукта;
- сервис статистики будет хранить количество просмотров и позволит делать различные выборки для анализа работы приложения.

Основной сервис реализует три вида API: публичный; для авторизованных пользователей; для администратора.

Публичный API:
- Публичный API должен предоставлять возможности поиска и фильтрации событий;
- Сортировка списка событий организована либо по количеству просмотров, которое будет запрашиваться в сервисе статистики, либо по датам событий;
- При просмотре списка событий возвращается только краткая информация о мероприятиях;
- Просмотр подробной информации о конкретном событии происходит отдельно (через отдельный эндпоинт);
- Каждое событие должно относиться к какой-то из закреплённых в приложении категорий;
- Имеется возможность получения всех имеющихся категорий и подборок событий (такие подборки будут составлять администраторы ресурса);
- Каждый публичный запрос для получения списка событий или полной информации о мероприятии фиксируется сервисом статистики.

API для авторизованных пользователей:
- Закрытая часть API реализует возможности зарегистрированных пользователей продукта;
- Авторизованные пользователи имеют возможность добавлять в приложение новые мероприятия, редактировать их и просматривать после добавления;
- Реализована возможность подачи заявок на участие в интересующих мероприятиях;
- Создатель мероприятия имеет возможность подтверждать заявки, которые отправили другие пользователи сервиса.

API для администратора:
- Административная часть API предоставляет возможности настройки и поддержки работы сервиса;
- Реализовано добавление, изменение и удаление категорий для событий;
- Реализована возможность добавлять, удалять и закреплять на главной странице подборки мероприятий;
- Реализована модерация событий, размещённых пользователями, — публикация или отклонение;
- Реализовано управление пользователями — добавление, активация, просмотр и удаление.

Сервис статистики
Второй сервис — сервис статистики. Он собирает информацию: во-первых, о количестве обращений пользователей к спискам событий и, во-вторых, о количестве запросов к подробной информации о событии. На основе этой информации должна формироваться статистика о работе приложения.

Функционал сервиса статистики содержит:
- запись информации о том, что был обработан запрос к эндпоинту API;
- предоставление статистики за выбранные даты по выбранному эндпоинту.

[back to table of content](#explore-with-me)

## Application architecture
Приложение реализовано на основе микросервисов.
Каждый сервис состоит из Клиента, который получает запросы и проверяет их на корректность. 
После проверки Клиент отправляет запрос в основной Сервис, который его обрабатывает. 

Сервис статистики поддерживает хранение информации в свободном формате (jsonb), для отправки которой необходимо указать два обязательных поля:
- название приложения, которое отправляет информацию (поле "app");
- время создания события (поле "timestamp", формат записи "yyyy-MM-dd HH:mm:ss").

![Arch.png](Arch.png)

[back to table of content](#explore-with-me)

## Schema of database
В приложении реализовано две базы данных:
- база данных основного сервиса;
- база данных статистики.
![Schema.png](Schema.png)

[back to table of content](#explore-with-me)

## Applied technologies
Приложение реализовано на основе Spring Boot

Сборка производится Maven

Кроме этого использованы следующие технологии:
- Spring JPA / Hibernate
- Docker
- Kubernetes / Helm

[back to table of content](#explore-with-me)

## How to Start a Program
### Docker
Для запуска программы достаточно выполнить следующую команду:

docker compose up

### Kubernetes
Работоспособность программы проверялась на основе ([minikube](https://kubernetes.io/ru/docs/tasks/tools/install-minikube/)).

Для запуска необходимо в первую очередь запустить кластер minikube посредством команды:

minikube start

Для обеспечения получения внешних запросов необходимо выполнить команду:

minikube tunnel

Запуск приложения осуществляется посредством последовательного выполнения следующих команд из папки kubernetes:

kubectl apply -f ewm-db-config.yaml

kubectl apply -f ewm-service-config.yaml     

kubectl apply -f ewm-db-secret.yaml

kubectl apply -f ewm-db.yaml

kubectl apply -f ewm-service.yaml

kubectl apply -f ewm-client-service.yaml  

kubectl apply -f stats-db-config.yaml

kubectl apply -f stats-service-config.yaml 

kubectl apply -f stats-db-secret.yaml

kubectl apply -f stats-db.yaml

kubectl apply -f stats-service.yaml

kubectl apply -f stats-client-service.yaml

kubectl apply -f ewm-ingress.yaml


### Helm chart
Работоспособность программы проверялась на основе ([minikube](https://kubernetes.io/ru/docs/tasks/tools/install-minikube/)).

Для запуска необходимо в первую очередь запустить кластер minikube посредством команды:

minikube start

Для обеспечения получения внешних запросов необходимо выполнить команду:

minikube tunnel

Запуск приложения осуществляется посредством выполнения следующей команды из папки kubernetes:

helm install app ewm-chart

[back to table of content](#explore-with-me)

## Description of feature

https://github.com/GlazyrinAV/java-explore-with-me/pull/6

ТЗ по реализуемой фиче - рейтинги событий и пользователей:
- Возможность ставить лайк/дизлайк событию. 
- Формирование рейтинга мероприятий и рейтинга их авторов. 
- Возможность сортировки событий в зависимости от рейтингов. 

Условия:
- Оценку мероприятий можно ставить только опубликованным событиям, которые завершены.
- Оценка м.б. от 1 до 5.
- Оценка мероприятия - среднее значение оценок всех пользователей с округлением до первого знака.
- Оценка автора - среднее значений оценок опубликованных и завершенных событий за последний год с округлением до первого знака.
- Оценку могут ставить только зарегистрированные на событие пользователи.
- Автор события не может ставить оценку мероприятию.
- Оценки отражаются при запросах событий.
- Оценку можно удалить.
- Подборки событий должны быть отсортированы по популярности (сначала популярные). 
- По умолчанию - оценка отсутствует.

Новые endpoint:
POST: /users/{userId}/events/{eventId}/like?mark={mark}
- если сохранено - 201
- если оценка существует - 409
- если ошибка в юзере, событии - 404
- если ошибка в оценки - 400
- если создает автор события - 409
- если создает пользователь не принимавший участие - 409
- если событие не наступило или не опубликовано - 409
DELETE: /users/{userId}/events/{eventId}/like 
- если удалено - 204
- если оценки не существует - 404
- если ошибка в юзере, событии - 404

[back to table of content](#explore-with-me)